<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Dashboard</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />

    <style>
      body {
        background: #161618;
        color: white;
      }
      .card {
        background: #36353b;
        border: none;
        color: #b0b0b0;
      }
      .card-title {
        color: white;
      }
      .btn-connect {
        background-color: #77f2a1;
        color: black;
        border: none;
      }
      .btn-disconnect {
        background-color: #f27777;
        color: black;
        border: none;
        display: none;
      }
      .btn-control {
        background-color: #53515b;
        color: white;
        border: none;
      }
      .sampling-rate-input {
        min-width: 100px;
      }
      .chartWrapper {
        max-height: 180px;
        height: 100%;
      }
    </style>
  </head>
  <body class="pt-1 pb-1">
    <div class="container-fluid">
      <div class="row gx-2">
        <!-- Connection Card -->
        <div class="col-12 col-md-6 col-xl-2 mt-2">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Connection</h5>
              <div class="card-text">
                <span id="connectedDevice" style="font-family: monospace"
                  >--</span
                ><br />
                FW:
                <span id="fwVersion" style="font-family: monospace">--</span>,
                HW:
                <span id="deviceVersion" style="font-family: monospace">--</span
                ><br />
              </div>
              <button
                id="connectDeviceButton"
                class="btn btn-connect w-100 mt-2"
              >
                Connect
              </button>
              <button
                id="disconnectDeviceButton"
                class="btn btn-disconnect w-100 mt-2"
              >
                Disconnect
              </button>
            </div>
          </div>
        </div>

        <!-- Sensor Control Card -->
        <div class="col-12 col-md-6 col-xl-4 mt-2">
          <div class="card h-100">
            <div class="card-body h-100 flex-column d-flex">
              <div class="d-flex flex-row w-100 justify-content-between">
                <h5 class="card-title">Sensor Control</h5>
              </div>
              <div class="d-flex flex-column flex-fill justify-content-between">
                <p class="card-text">
                  Select sensors and sampling rate to capture.
                </p>

                <!-- Grid Layout Starts Here -->
                <div
                  style="
                    display: grid;
                    grid-template-columns: auto 1fr auto auto;
                    gap: 16px;
                    align-items: center;
                  "
                >
                  <!-- IMU Row -->
                  <div>
                    <input
                      type="checkbox"
                      disabled
                      class="is-connect-enabled"
                      id="areSensorsEnabled"
                    />
                  </div>
                  <div
                    class="ms-2"
                    style="
                      overflow: hidden;
                      white-space: nowrap;
                      text-overflow: ellipsis;
                    "
                  >
                    Accelerometer, Gyroscope, Magnetometer (via BLE)
                  </div>
                  <div>
                    <select
                      disabled
                      class="w-100 is-connect-enabled ms-1 sampling-rate-input form-select"
                      id="sensorSamplingRate"
                    >
                      <option value="0">0</option>
                      <option value="10">10</option>
                      <option value="20">20</option>
                      <option value="30">30</option>
                      <option value="40">40</option>
                      <option value="50">50</option>
                    </select>
                  </div>
                  <div class="ms-1">Hz</div>
                </div>
                <!-- Grid Layout Ends Here -->

                <div class="d-flex flex-row mt-3 w-100 justify-content-between">
                  <button
                    id="setSensorConfigurationButton"
                    class="btn btn-control is-connect-enabled flex-fill"
                    disabled
                  >
                    Set Configuration
                  </button>
                  <button
                    id="testOcclusionButton"
                    class="btn btn-control is-connect-enabled ms-3"
                    disabled
                    style="min-width: 120px"
                  >
                    Test Occl.
                  </button>
                  <button class="btn btn-stop is-connect-enabled ms-3" disabled>
                    Off
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row gx-2 mt-2">
        <!-- Accelerometer -->
        <div class="col-12 col-md-6 col-xl-4">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Accelerometer</h5>
              <div class="chartWrapper">
                <canvas id="accelerometerChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <!-- Gyroscope -->
        <div class="col-12 col-md-6 col-xl-4">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Gyroscope</h5>
              <div class="chartWrapper">
                <canvas id="gyroscopeChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <!-- Magnetometer -->
        <div class="col-12 col-md-6 col-xl-4">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Magnetometer</h5>
              <div class="chartWrapper">
                <canvas id="magnetometerChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Core Modules -->
    <script src="./assets/js/OpenEarable.js"></script>
    <script src="./assets/js/ConnectionManager.js"></script>
    <script src="./assets/js/SensorManager.js"></script>
    <script src="./assets/js/ChartManager.js"></script>

    <script>
      $(document).ready(function () {
        $("#disconnectDeviceButton").hide();
        $("#toggleSensorReading").prop("disabled", true);

        $("#connectDeviceButton").click(async function () {
          $(this).prop("disabled", true);
          try {
            await openEarable.bleManager.connect();
          } catch (e) {
            $(this).prop("disabled", false);
          }
        });

        $("#disconnectDeviceButton").click(() => {
          openEarable.bleManager.disconnect();
        });

        openEarable.bleManager.subscribeOnConnected(async () => {
          $("#connectDeviceButton").hide();
          $("#disconnectDeviceButton").show().prop("disabled", false);
          $("#setSensorConfigurationButton").prop("disabled", false);
          $("#connectedDevice").text(openEarable.bleManager.deviceName);
          $("#fwVersion").text(await openEarable.readFirmwareVersion());
          $("#deviceVersion").text(await openEarable.readHardwareVersion());
        });

        openEarable.bleManager.subscribeOnDisconnected(() => {
          $("#disconnectDeviceButton").hide();
          $("#connectDeviceButton").show().prop("disabled", false);
          $("#setSensorConfigurationButton").prop("disabled", true);
        });

        $("#setSensorConfigurationButton").click(async function () {
          const rate = parseInt($("#sensorSamplingRate").val(), 10);
          await openEarable.sensorManager.writeSensorConfig(0, rate, 0);
        });

        setupCharts();
        openEarable.sensorManager.subscribeOnSensorDataReceived((data) =>
          updateSensorCharts(data)
        );
      });
    </script>
  </body>
</html>
